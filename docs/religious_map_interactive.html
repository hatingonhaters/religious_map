
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Religious University Survivability Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    html, body, #map { height: 100%; margin: 0; }
    #legend {
      position: fixed;
      bottom: 30px;
      left: 30px;
      width: 230px;
      background: white;
      border: 2px solid grey;
      padding: 10px;
      font-size: 14px;
      z-index: 9999;
    }
    #filter {
      position: fixed;
      top: 10px;
      left: 30px;
      background: white;
      padding: 10px;
      z-index: 9999;
      font-size: 14px;
      border: 2px solid grey;
    }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body>
<div id="filter">
  <label for="denomination-select"><strong>Filter by Denomination:</strong></label>
  <select id="denomination-select">
    <option value="All">All</option>
  </select>
</div>
<div id="legend">
  <b>Survivability Index</b><br>
  <i style="color:#006837;">⬤</i> Elite<br>
  <i style="color:#1a9850;">⬤</i> Excellent<br>
  <i style="color:#66bd63;">⬤</i> Very Strong<br>
  <i style="color:#a6d96a;">⬤</i> Strong<br>
  <i style="color:#d9ef8b;">⬤</i> Stable<br>
  <i style="color:#fee08b;">⬤</i> Vulnerable<br>
  <i style="color:#fdae61;">⬤</i> Endangered<br>
  <i style="color:#f46d43;">⬤</i> Critical<br>
</div>
<div id="map"></div>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://d3js.org/d3.v5.min.js"></script>
<script>
  const map = L.map('map').setView([39.5, -98.35], 5);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors'
  }).addTo(map);

  const colors = ['#006837', '#1a9850', '#66bd63', '#a6d96a', '#d9ef8b', '#fee08b', '#fdae61', '#f46d43'];

  function getColor(value, breaks) {
    for (let i = 0; i < breaks.length - 1; i++) {
      if (value >= breaks[i] && value <= breaks[i + 1]) {
        return colors[i];
      }
    }
    return "#000000";
  }

  const pins = [];
  const denominationSet = new Set();

  d3.csv("religious_map_data.csv").then(data => {
    const survivability = data.map(d => +d.Survivability).sort((a, b) => a - b);
    const breaks = [];
    for (let i = 0; i <= 8; i++) {
      breaks.push(survivability[Math.floor(i * survivability.length / 8)]);
    }

    data.forEach(d => {
      denominationSet.add(d.Religion);

      const popup = `
        <b>${d.University}</b><br>
        ${d.City}, ${d.State}<br>
        Religion: ${d.Religion}<br>
        Market Saturation: ${d.Market_Saturation_Percentile}<br>
        Academic Efficiency: ${d.Academic_Efficiency_Percentile}<br>
        aCFI: ${d.aCFI_Percentile}<br>
        Survivability: ${d.Survivability}
      `;
      const marker = L.marker([+d.Latitude, +d.Longitude], {
        icon: L.divIcon({ className: 'emoji-icon', html: `<div style="color:${getColor(+d.Survivability, breaks)};">⛪</div>` })
      }).bindPopup(popup);
      marker.religion = d.Religion;
      marker.addTo(map);
      pins.push(marker);
    });

    // Populate dropdown
    const select = document.getElementById("denomination-select");
    Array.from(denominationSet).sort().forEach(denom => {
      const option = document.createElement("option");
      option.value = denom;
      option.textContent = denom;
      select.appendChild(option);
    });

    select.addEventListener("change", e => {
      const value = e.target.value;
      pins.forEach(pin => {
        if (value === "All" || pin.religion === value) {
          map.addLayer(pin);
        } else {
          map.removeLayer(pin);
        }
      });
    });
  });
</script>
</body>
</html>
